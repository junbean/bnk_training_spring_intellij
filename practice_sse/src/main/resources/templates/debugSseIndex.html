<!DOCTYPE html>
<html>
<head>
  <title>SSE ë””ë²„ê·¸ ë° ëª¨ë‹ˆí„°ë§</title>
  <style>
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin: 20px;
        background-color: #1e1e1e;
        color: #ffffff;
    }
    .container {
        max-width: 1000px;
        margin: 0 auto;
        background: #2d2d2d;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    .debug-panel {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin: 20px 0;
    }
    .info-box {
        background: #3a3a3a;
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid #007acc;
    }
    .connection-info { border-left-color: #28a745; }
    .event-info { border-left-color: #ffc107; }
    .error-info { border-left-color: #dc3545; }
    .performance-info { border-left-color: #17a2b8; }

    button {
        padding: 12px 24px;
        margin: 8px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        transition: all 0.3s;
    }
    .start-btn {
        background: linear-gradient(45deg, #007acc, #0099ff);
        color: white;
    }
    .start-btn:hover { transform: translateY(-2px); }
    .stop-btn {
        background: linear-gradient(45deg, #6c757d, #5a6268);
        color: white;
    }

    .console-log {
        background: #1a1a1a;
        border: 1px solid #444;
        padding: 15px;
        margin: 15px 0;
        height: 300px;
        overflow-y: auto;
        font-family: 'Courier New', monospace;
        font-size: 13px;
        border-radius: 6px;
    }

    .log-entry {
        margin: 3px 0;
        padding: 2px 0;
    }
    .log-debug { color: #17a2b8; }
    .log-info { color: #28a745; }
    .log-warning { color: #ffc107; }
    .log-error { color: #dc3545; }
    .log-data { color: #6f42c1; }

    .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
    }
    .status-connected { background-color: #28a745; }
    .status-connecting { background-color: #ffc107; }
    .status-disconnected { background-color: #dc3545; }

    .metric {
        display: flex;
        justify-content: space-between;
        margin: 8px 0;
    }
    .metric-value {
        font-weight: bold;
        color: #007acc;
    }
  </style>
</head>
<body>
<div class="container">
  <h1>ğŸ” SSE ë””ë²„ê·¸ ë° ì—°ê²° ëª¨ë‹ˆí„°ë§</h1>

  <div>
    <button class="start-btn" onclick="startDebugSSE()">ğŸš€ ë””ë²„ê·¸ SSE ì‹œì‘</button>
    <button class="stop-btn" onclick="stopDebugSSE()">ğŸ›‘ ì—°ê²° ì¤‘ì§€</button>
    <button class="stop-btn" onclick="clearLogs()">ğŸ—‘ï¸ ë¡œê·¸ ì§€ìš°ê¸°</button>
  </div>

  <div class="debug-panel">
    <!-- ì—°ê²° ì •ë³´ -->
    <div class="info-box connection-info">
      <h3>ğŸ”Œ ì—°ê²° ìƒíƒœ</h3>
      <div class="metric">
        <span>ìƒíƒœ:</span>
        <span id="connection-status">
                        <span class="status-indicator status-disconnected"></span>
                        ì—°ê²°ë˜ì§€ ì•ŠìŒ
                    </span>
      </div>
      <div class="metric">
        <span>ì—°ê²° ì‹œê°„:</span>
        <span id="connection-time" class="metric-value">-</span>
      </div>
      <div class="metric">
        <span>ReadyState:</span>
        <span id="ready-state" class="metric-value">-</span>
      </div>
      <div class="metric">
        <span>URL:</span>
        <span id="connection-url" class="metric-value">-</span>
      </div>
    </div>

    <!-- ì´ë²¤íŠ¸ í†µê³„ -->
    <div class="info-box event-info">
      <h3>ğŸ“Š ì´ë²¤íŠ¸ í†µê³„</h3>
      <div class="metric">
        <span>ë°›ì€ ë©”ì‹œì§€:</span>
        <span id="message-count" class="metric-value">0</span>
      </div>
      <div class="metric">
        <span>ë§ˆì§€ë§‰ ì´ë²¤íŠ¸:</span>
        <span id="last-event-time" class="metric-value">-</span>
      </div>
      <div class="metric">
        <span>ë§ˆì§€ë§‰ ì´ë²¤íŠ¸ ID:</span>
        <span id="last-event-id" class="metric-value">-</span>
      </div>
      <div class="metric">
        <span>í‰ê·  ê°„ê²©:</span>
        <span id="average-interval" class="metric-value">-</span>
      </div>
    </div>

    <!-- ì—ëŸ¬ ì •ë³´ -->
    <div class="info-box error-info">
      <h3>âš ï¸ ì—ëŸ¬ ë° ê²½ê³ </h3>
      <div class="metric">
        <span>ì—ëŸ¬ íšŸìˆ˜:</span>
        <span id="error-count" class="metric-value">0</span>
      </div>
      <div class="metric">
        <span>ì¬ì—°ê²° ì‹œë„:</span>
        <span id="reconnect-count" class="metric-value">0</span>
      </div>
      <div class="metric">
        <span>ë§ˆì§€ë§‰ ì—ëŸ¬:</span>
        <span id="last-error" class="metric-value">ì—†ìŒ</span>
      </div>
    </div>

    <!-- ì„±ëŠ¥ ì •ë³´ -->
    <div class="info-box performance-info">
      <h3>âš¡ ì„±ëŠ¥ ë©”íŠ¸ë¦­</h3>
      <div class="metric">
        <span>ì—°ê²° ì§€ì—°ì‹œê°„:</span>
        <span id="connection-latency" class="metric-value">-</span>
      </div>
      <div class="metric">
        <span>ë°ì´í„° ì „ì†¡ë¥ :</span>
        <span id="data-rate" class="metric-value">-</span>
      </div>
      <div class="metric">
        <span>ì´ ë°›ì€ ë°”ì´íŠ¸:</span>
        <span id="total-bytes" class="metric-value">0</span>
      </div>
    </div>
  </div>

  <h3>ğŸ“ ì‹¤ì‹œê°„ ì½˜ì†” ë¡œê·¸</h3>
  <div id="console-log" class="console-log"></div>
</div>

<script>
  let debugSource = null;
  let connectionStartTime = null;
  let messageCount = 0;
  let errorCount = 0;
  let reconnectCount = 0;
  let totalBytes = 0;
  let lastEventTimes = [];

  function startDebugSSE() {
      // ê¸°ì¡´ ì—°ê²° ì •ë¦¬
      if (debugSource) {
          debugSource.close();
      }

      // ë©”íŠ¸ë¦­ ì´ˆê¸°í™”
      resetMetrics();
      connectionStartTime = Date.now();

      addLog('ğŸš€ ë””ë²„ê·¸ SSE ì—°ê²° ì‹œì‘...', 'debug');
      updateConnectionStatus('connecting', 'ì—°ê²° ì¤‘...');

      // SSE ì—°ê²° ìƒì„±
      debugSource = new EventSource('/api/debug-events');
      updateConnectionInfo();

      // ì—°ê²° ì„±ê³µ ì´ë²¤íŠ¸
      debugSource.onopen = function(event) {
          const connectionTime = Date.now() - connectionStartTime;
          updateConnectionStatus('connected', 'ì—°ê²°ë¨');
          updateMetric('connection-time', formatDuration(Date.now() - connectionStartTime));
          updateMetric('connection-latency', connectionTime + 'ms');
          updateMetric('ready-state', getReadyStateText(debugSource.readyState));

          addLog('âœ… ì„œë²„ ì—°ê²° ì„±ê³µ (ì§€ì—°ì‹œê°„: ' + connectionTime + 'ms)', 'info');
          addLog('ğŸ” ì—°ê²° ìƒíƒœ - ReadyState: ' + debugSource.readyState, 'debug');
      };

      // ë””ë²„ê·¸ ë©”ì‹œì§€ ì²˜ë¦¬
      debugSource.addEventListener('debug-message', function(event) {
          messageCount++;
          const eventTime = Date.now();
          lastEventTimes.push(eventTime);
          totalBytes += event.data.length;

          updateMetric('message-count', messageCount);
          updateMetric('last-event-time', new Date().toLocaleTimeString());
          updateMetric('last-event-id', event.lastEventId || 'ì—†ìŒ');
          updateMetric('total-bytes', totalBytes + ' bytes');

          // í‰ê·  ê°„ê²© ê³„ì‚°
          if (lastEventTimes.length > 1) {
              const intervals = [];
              for (let i = 1; i < lastEventTimes.length; i++) {
                  intervals.push(lastEventTimes[i] - lastEventTimes[i-1]);
              }
              const avgInterval = intervals.reduce((a, b) => a + b, 0) / intervals.length;
              updateMetric('average-interval', Math.round(avgInterval) + 'ms');
          }

          addLog(`ğŸ“¨ [ID: ${event.lastEventId}] ${event.data}`, 'data');
          addLog(`ğŸ” ì´ë²¤íŠ¸ ìƒì„¸ - íƒ€ì…: debug-message, í¬ê¸°: ${event.data.length} bytes`, 'debug');
      });

      // ì™„ë£Œ ë©”ì‹œì§€ ì²˜ë¦¬
      debugSource.addEventListener('completion', function(event) {
          addLog('ğŸ ' + event.data, 'info');
          addLog('ğŸ” ëª¨ë“  ë©”ì‹œì§€ ì „ì†¡ ì™„ë£Œ - ì„œë²„ì—ì„œ ì—°ê²° ì¢…ë£Œ ì˜ˆì •', 'debug');
      });

      // ê¸°ë³¸ ë©”ì‹œì§€ í•¸ë“¤ëŸ¬
      debugSource.onmessage = function(event) {
          addLog('ğŸ“¨ ê¸°ë³¸ ë©”ì‹œì§€: ' + event.data, 'data');
      };

      // ì—ëŸ¬ ë° ì—°ê²° ì¢…ë£Œ ì²˜ë¦¬
      debugSource.onerror = function(event) {
          errorCount++;
          updateMetric('error-count', errorCount);
          updateMetric('last-error', new Date().toLocaleTimeString());

          const readyState = debugSource.readyState;
          updateMetric('ready-state', getReadyStateText(readyState));

          if (readyState === EventSource.CLOSED) {
              updateConnectionStatus('disconnected', 'ì—°ê²° ì¢…ë£Œë¨');
              addLog('ğŸ”Œ ì—°ê²°ì´ ì™„ì „íˆ ì¢…ë£Œë¨', 'info');
              addLog('ğŸ” ìµœì¢… ìƒíƒœ - ReadyState: ' + readyState + ' (CLOSED)', 'debug');
          } else if (readyState === EventSource.CONNECTING) {
              reconnectCount++;
              updateMetric('reconnect-count', reconnectCount);
              updateConnectionStatus('connecting', 'ì¬ì—°ê²° ì‹œë„ ì¤‘...');
              addLog('ğŸ”„ ì¬ì—°ê²° ì‹œë„ ì¤‘... (ì‹œë„ #' + reconnectCount + ')', 'warning');
              addLog('ğŸ” ì—°ê²° ìƒíƒœ - ReadyState: ' + readyState + ' (CONNECTING)', 'debug');
          } else {
              updateConnectionStatus('disconnected', 'ì—ëŸ¬ ë°œìƒ');
              addLog('âŒ ì•Œ ìˆ˜ ì—†ëŠ” ì—ëŸ¬ ë°œìƒ', 'error');
              addLog('ğŸ” ì—ëŸ¬ ìƒíƒœ - ReadyState: ' + readyState, 'debug');
          }
      };

      // ì£¼ê¸°ì ìœ¼ë¡œ ì—°ê²° ìƒíƒœ ì—…ë°ì´íŠ¸
      const statusInterval = setInterval(() => {
          if (debugSource && debugSource.readyState === EventSource.OPEN) {
              updateMetric('connection-time', formatDuration(Date.now() - connectionStartTime));

              // ë°ì´í„° ì „ì†¡ë¥  ê³„ì‚° (bytes/second)
              const connectionDuration = (Date.now() - connectionStartTime) / 1000;
              const dataRate = (totalBytes / connectionDuration).toFixed(2);
              updateMetric('data-rate', dataRate + ' bytes/sec');
          } else {
              clearInterval(statusInterval);
          }
      }, 1000);
  }

  function stopDebugSSE() {
      if (debugSource) {
          addLog('ğŸ›‘ ì‚¬ìš©ìê°€ ì—°ê²°ì„ ìˆ˜ë™ìœ¼ë¡œ ì¤‘ì§€í•¨', 'warning');
          debugSource.close();
          updateConnectionStatus('disconnected', 'ìˆ˜ë™ìœ¼ë¡œ ì¤‘ì§€ë¨');
          updateMetric('ready-state', getReadyStateText(debugSource.readyState));
          debugSource = null;
      } else {
          addLog('âš ï¸ ì¤‘ì§€í•  ì—°ê²°ì´ ì—†ìŒ', 'warning');
      }
  }

  function clearLogs() {
      document.getElementById('console-log').innerHTML = '';
      addLog('ğŸ—‘ï¸ ë¡œê·¸ê°€ ì§€ì›Œì¡ŒìŠµë‹ˆë‹¤', 'info');
  }

  // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
  function updateConnectionStatus(status, message) {
      const statusElement = document.getElementById('connection-status');
      const indicator = statusElement.querySelector('.status-indicator');

      indicator.className = 'status-indicator status-' + status;
      statusElement.innerHTML = `<span class="status-indicator status-${status}"></span>${message}`;
  }

  function updateConnectionInfo() {
      if (debugSource) {
          updateMetric('connection-url', debugSource.url);
          updateMetric('ready-state', getReadyStateText(debugSource.readyState));
      }
  }

  function updateMetric(id, value) {
      const element = document.getElementById(id);
      if (element) {
          element.textContent = value;
      }
  }

  function resetMetrics() {
      messageCount = 0;
      errorCount = 0;
      reconnectCount = 0;
      totalBytes = 0;
      lastEventTimes = [];

      updateMetric('message-count', '0');
      updateMetric('error-count', '0');
      updateMetric('reconnect-count', '0');
      updateMetric('total-bytes', '0 bytes');
      updateMetric('last-event-time', '-');
      updateMetric('last-event-id', '-');
      updateMetric('average-interval', '-');
      updateMetric('connection-latency', '-');
      updateMetric('data-rate', '-');
      updateMetric('last-error', 'ì—†ìŒ');
  }

  function getReadyStateText(state) {
      switch(state) {
          case EventSource.CONNECTING: return '0 (CONNECTING)';
          case EventSource.OPEN: return '1 (OPEN)';
          case EventSource.CLOSED: return '2 (CLOSED)';
          default: return state + ' (UNKNOWN)';
      }
  }

  function formatDuration(ms) {
      const seconds = Math.floor(ms / 1000);
      const minutes = Math.floor(seconds / 60);
      const hours = Math.floor(minutes / 60);

      if (hours > 0) {
          return `${hours}ì‹œê°„ ${minutes % 60}ë¶„ ${seconds % 60}ì´ˆ`;
      } else if (minutes > 0) {
          return `${minutes}ë¶„ ${seconds % 60}ì´ˆ`;
      } else {
          return `${seconds}ì´ˆ`;
      }
  }

  function addLog(message, type = 'info') {
      const logDiv = document.getElementById('console-log');
      const time = new Date().toLocaleTimeString();
      const logEntry = document.createElement('div');

      logEntry.className = `log-entry log-${type}`;
      logEntry.innerHTML = `[${time}] ${message}`;

      logDiv.appendChild(logEntry);
      logDiv.scrollTop = logDiv.scrollHeight;
  }

  // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
  window.addEventListener('load', function() {
      resetMetrics();
      addLog('ğŸ“„ SSE ë””ë²„ê·¸ í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ', 'info');
      addLog('ğŸ” EventSource ì§€ì› ì—¬ë¶€: ' + ('EventSource' in window ? 'ì§€ì›ë¨' : 'ì§€ì›ë˜ì§€ ì•ŠìŒ'), 'debug');
  });

  // í˜ì´ì§€ ì¢…ë£Œ ì‹œ ì—°ê²° ì •ë¦¬
  window.addEventListener('beforeunload', function() {
      if (debugSource) {
          debugSource.close();
      }
  });
</script>
</body>
</html>