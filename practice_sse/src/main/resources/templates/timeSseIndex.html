<!DOCTYPE html>
<html>
<head>
  <title>ì‹¤ì‹œê°„ ì‹œê³„ - SSE</title>
  <style>
    body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background-color: #f0f0f0;
    }
    .clock-container {
        text-align: center;
        margin: 20px 0;
    }
    #clock {
        font-size: 2em;
        font-weight: bold;
        color: #333;
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        display: inline-block;
        min-width: 300px;
    }
    #status {
        margin: 10px 0;
        padding: 10px;
        border-radius: 5px;
    }
    .connected { background-color: #d4edda; color: #155724; }
    .disconnected { background-color: #f8d7da; color: #721c24; }
    .connecting { background-color: #fff3cd; color: #856404; }
    button {
        padding: 10px 20px;
        margin: 5px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
    }
    .start-btn { background-color: #28a745; color: white; }
    .stop-btn { background-color: #dc3545; color: white; }
    #log {
        margin-top: 20px;
        height: 200px;
        overflow-y: auto;
        border: 1px solid #ccc;
        padding: 10px;
        background: white;
    }
  </style>
</head>
<body>
<h1>ğŸ• ì‹¤ì‹œê°„ ì„œë²„ ì‹œê³„</h1>

<div class="clock-container">
  <div id="clock">ì‹œê³„ë¥¼ ì‹œì‘í•˜ì„¸ìš”</div>
  <div id="status" class="disconnected">ì—°ê²°ë˜ì§€ ì•ŠìŒ</div>
</div>

<div>
  <button class="start-btn" onclick="startClock()">ì‹œê³„ ì‹œì‘</button>
  <button class="stop-btn" onclick="stopClock()">ì‹œê³„ ì¤‘ì§€</button>
</div>

<h3>ì—°ê²° ë¡œê·¸</h3>
<div id="log"></div>

<script>
  let timeSource = null;

  function startClock() {
      // ì´ë¯¸ ì—°ê²°ì´ ìˆìœ¼ë©´ ì¢…ë£Œ
      if (timeSource) {
          timeSource.close();
      }

      updateStatus('connecting', 'ì—°ê²° ì¤‘...');
      addLog('ì‹œê³„ SSE ì—°ê²° ì‹œë„');

      // SSE ì—°ê²° ìƒì„±
      timeSource = new EventSource('/api/current-time');

      // ì—°ê²° ì„±ê³µ
      timeSource.onopen = function(event) {
          updateStatus('connected', 'ì—°ê²°ë¨ - ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì¤‘');
          addLog('âœ… ì„œë²„ì™€ ì—°ê²° ì„±ê³µ');
      };

      // ì‹œê°„ ì—…ë°ì´íŠ¸ ì´ë²¤íŠ¸ ì²˜ë¦¬
      // ì„œë²„ì—ì„œ .name("time-update")ë¡œ ë³´ë‚¸ ì´ë²¤íŠ¸ë§Œ ì²˜ë¦¬
      timeSource.addEventListener('time-update', function(event) {
          // ë°›ì€ ì‹œê°„ì„ ì‹œê³„ì— í‘œì‹œ
          document.getElementById('clock').textContent = 'ğŸ• ' + event.data;
          addLog('â° ì‹œê°„ ì—…ë°ì´íŠ¸: ' + event.data);
      });

      // ì¼ë°˜ ë©”ì‹œì§€ (í˜¹ì‹œ ë‹¤ë¥¸ íƒ€ì…ì˜ ë©”ì‹œì§€ê°€ ì˜¬ ê²½ìš°)
      timeSource.onmessage = function(event) {
          addLog('ğŸ“¨ ì¼ë°˜ ë©”ì‹œì§€: ' + event.data);
      };

      // ì—ëŸ¬ ë˜ëŠ” ì—°ê²° ì¢…ë£Œ
      timeSource.onerror = function(event) {
          updateStatus('disconnected', 'ì—°ê²° ëŠì–´ì§');
          addLog('âŒ ì—°ê²° ì—ëŸ¬ ë˜ëŠ” ì¢…ë£Œ');

          // ì—°ê²° ìƒíƒœ í™•ì¸
          if (timeSource.readyState === EventSource.CLOSED) {
              addLog('ğŸ”Œ ì—°ê²°ì´ ì™„ì „íˆ ì¢…ë£Œë¨');
          } else if (timeSource.readyState === EventSource.CONNECTING) {
              addLog('ğŸ”„ ì¬ì—°ê²° ì‹œë„ ì¤‘...');
          }
      };
  }

  function stopClock() {
      if (timeSource) {
          timeSource.close();
          updateStatus('disconnected', 'ìˆ˜ë™ìœ¼ë¡œ ì¤‘ì§€ë¨');
          addLog('ğŸ›‘ ì‚¬ìš©ìê°€ ì‹œê³„ë¥¼ ì¤‘ì§€í•¨');
          timeSource = null;

          // ì‹œê³„ ì´ˆê¸°í™”
          document.getElementById('clock').textContent = 'ì‹œê³„ê°€ ì¤‘ì§€ë¨';
      } else {
          addLog('âš ï¸ ì¤‘ì§€í•  ì—°ê²°ì´ ì—†ìŒ');
      }
  }

  // ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸
  function updateStatus(type, message) {
      const statusDiv = document.getElementById('status');
      statusDiv.className = type;
      statusDiv.textContent = message;
  }

  // ë¡œê·¸ ì¶”ê°€
  function addLog(message) {
      const logDiv = document.getElementById('log');
      const time = new Date().toLocaleTimeString();
      const logEntry = document.createElement('div');
      logEntry.innerHTML = `[${time}] ${message}`;
      logDiv.appendChild(logEntry);

      // ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ
      logDiv.scrollTop = logDiv.scrollHeight;
  }

  // í˜ì´ì§€ ì¢…ë£Œ ì‹œ ì—°ê²° ì •ë¦¬
  window.addEventListener('beforeunload', function() {
      if (timeSource) {
          timeSource.close();
      }
  });
</script>
</body>
</html>