<!DOCTYPE html>
<html>
<head>
  <title>ë‹¤ì–‘í•œ ì´ë²¤íŠ¸ íƒ€ì… - SSE</title>
  <style>
    body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background-color: #f5f5f5;
    }
    .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .event-section {
        margin: 15px 0;
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid #ccc;
    }
    .welcome { border-left-color: #28a745; background-color: #d4edda; }
    .notification { border-left-color: #ffc107; background-color: #fff3cd; }
    .data { border-left-color: #17a2b8; background-color: #d1ecf1; }
    .numbered { border-left-color: #6f42c1; background-color: #e2d9f3; }
    .goodbye { border-left-color: #dc3545; background-color: #f8d7da; }

    button {
        padding: 12px 24px;
        margin: 10px 5px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
    }
    .start-btn { background-color: #007bff; color: white; }
    .stop-btn { background-color: #6c757d; color: white; }

    .event-log {
        margin-top: 20px;
        height: 300px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        padding: 15px;
        background-color: #f8f9fa;
        font-family: 'Courier New', monospace;
    }

    .json-data {
        background-color: #f1f3f4;
        padding: 10px;
        border-radius: 4px;
        font-family: monospace;
        margin: 5px 0;
    }

    .status {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
        font-weight: bold;
    }
    .status.connected { background-color: #d4edda; color: #155724; }
    .status.disconnected { background-color: #f8d7da; color: #721c24; }
  </style>
</head>
<body>
<div class="container">
  <h1>ğŸ­ ë‹¤ì–‘í•œ ì´ë²¤íŠ¸ íƒ€ì… SSE í…ŒìŠ¤íŠ¸</h1>

  <div id="connection-status" class="status disconnected">ì—°ê²°ë˜ì§€ ì•ŠìŒ</div>

  <div>
    <button class="start-btn" onclick="startMixedEvents()">ì´ë²¤íŠ¸ ìŠ¤íŠ¸ë¦¼ ì‹œì‘</button>
    <button class="stop-btn" onclick="stopMixedEvents()">ì—°ê²° ì¤‘ì§€</button>
  </div>

  <!-- ê° ì´ë²¤íŠ¸ íƒ€ì…ë³„ í‘œì‹œ ì˜ì—­ -->
  <div id="welcome-section" class="event-section welcome" style="display: none;">
    <h3>ğŸ‰ í™˜ì˜ ë©”ì‹œì§€</h3>
    <div id="welcome-content"></div>
  </div>

  <div id="notification-section" class="event-section notification" style="display: none;">
    <h3>ğŸ”” ì•Œë¦¼</h3>
    <div id="notification-content"></div>
  </div>

  <div id="data-section" class="event-section data" style="display: none;">
    <h3>ğŸ“Š ë°ì´í„°</h3>
    <div id="data-content"></div>
  </div>

  <div id="numbered-section" class="event-section numbered" style="display: none;">
    <h3>ğŸ”¢ ìˆœì„œê°€ ìˆëŠ” ë©”ì‹œì§€</h3>
    <div id="numbered-content"></div>
  </div>

  <div id="goodbye-section" class="event-section goodbye" style="display: none;">
    <h3>ğŸ‘‹ ì‘ë³„ ë©”ì‹œì§€</h3>
    <div id="goodbye-content"></div>
  </div>

  <h3>ğŸ“ ìƒì„¸ ë¡œê·¸</h3>
  <div id="event-log" class="event-log"></div>
</div>

<script>
  let mixedSource = null;

  function startMixedEvents() {
      // ê¸°ì¡´ ì—°ê²° ì •ë¦¬
      if (mixedSource) {
          mixedSource.close();
      }

      // UI ì´ˆê¸°í™”
      resetUI();
      updateConnectionStatus(true, 'ì—°ê²° ì¤‘...');
      addLog('ğŸš€ í˜¼í•© ì´ë²¤íŠ¸ SSE ì—°ê²° ì‹œì‘');

      // SSE ì—°ê²° ìƒì„±
      mixedSource = new EventSource('/api/mixed-events');

      // ì—°ê²° ì„±ê³µ ì´ë²¤íŠ¸
      mixedSource.onopen = function(event) {
          updateConnectionStatus(true, 'ì—°ê²°ë¨ - ì´ë²¤íŠ¸ ìˆ˜ì‹  ì¤‘');
          addLog('âœ… ì„œë²„ ì—°ê²° ì„±ê³µ');
      };

      // 1. í™˜ì˜ ë©”ì‹œì§€ ì²˜ë¦¬
      mixedSource.addEventListener('welcome', function(event) {
          showSection('welcome-section');
          document.getElementById('welcome-content').innerHTML =
              `<p><strong>${event.data}</strong></p>`;
          addLog('ğŸ‰ í™˜ì˜ ë©”ì‹œì§€ ë°›ìŒ: ' + event.data);
      });

      // 2. ì•Œë¦¼ ì²˜ë¦¬
      mixedSource.addEventListener('notification', function(event) {
          showSection('notification-section');
          document.getElementById('notification-content').innerHTML =
              `<p>âš ï¸ ${event.data}</p>`;
          addLog('ğŸ”” ì•Œë¦¼ ë°›ìŒ: ' + event.data);

          // ë¸Œë¼ìš°ì € ì•Œë¦¼ë„ í‘œì‹œ (ê¶Œí•œì´ ìˆëŠ” ê²½ìš°)
          if (Notification.permission === 'granted') {
              new Notification('SSE ì•Œë¦¼', { body: event.data });
          }
      });

      // 3. ë°ì´í„° ì²˜ë¦¬ (JSON)
      mixedSource.addEventListener('data', function(event) {
          showSection('data-section');
          try {
              // JSON íŒŒì‹± ì‹œë„
              const userData = JSON.parse(event.data);
              document.getElementById('data-content').innerHTML = `
                  <div class="json-data">
                      <strong>ì‚¬ìš©ì ì •ë³´:</strong><br>
                      ğŸ‘¤ ì´ë¦„: ${userData.user}<br>
                      ğŸŸ¢ ìƒíƒœ: ${userData.status}<br>
                      â° ë¡œê·¸ì¸ ì‹œê°„: ${userData.loginTime}
                  </div>
              `;
              addLog('ğŸ“Š JSON ë°ì´í„° ë°›ìŒ: ' + JSON.stringify(userData, null, 2));
          } catch (e) {
              // JSONì´ ì•„ë‹Œ ê²½ìš° ê·¸ëŒ€ë¡œ í‘œì‹œ
              document.getElementById('data-content').innerHTML =
                  `<div class="json-data">${event.data}</div>`;
              addLog('ğŸ“Š ë°ì´í„° ë°›ìŒ: ' + event.data);
          }
      });

      // 4. ë²ˆí˜¸ê°€ ìˆëŠ” ë©”ì‹œì§€ ì²˜ë¦¬
      mixedSource.addEventListener('numbered', function(event) {
          showSection('numbered-section');
          const content = document.getElementById('numbered-content');
          const messageDiv = document.createElement('div');
          messageDiv.innerHTML = `
              <p><strong>ID:</strong> ${event.lastEventId} | <strong>ë‚´ìš©:</strong> ${event.data}</p>
          `;
          content.appendChild(messageDiv);

          addLog(`ğŸ”¢ ìˆœì„œ ë©”ì‹œì§€ [ID: ${event.lastEventId}]: ${event.data}`);
      });

      // 5. ì‘ë³„ ë©”ì‹œì§€ ì²˜ë¦¬
      mixedSource.addEventListener('goodbye', function(event) {
          showSection('goodbye-section');
          document.getElementById('goodbye-content').innerHTML =
              `<p><strong>${event.data}</strong></p>`;
          addLog('ğŸ‘‹ ì‘ë³„ ë©”ì‹œì§€: ' + event.data);
      });

      // ê¸°ë³¸ ë©”ì‹œì§€ í•¸ë“¤ëŸ¬ (íƒ€ì…ì´ ì§€ì •ë˜ì§€ ì•Šì€ ë©”ì‹œì§€)
      mixedSource.onmessage = function(event) {
          addLog('ğŸ“¨ ê¸°ë³¸ ë©”ì‹œì§€: ' + event.data);
      };

      // ì—ëŸ¬ ë° ì—°ê²° ì¢…ë£Œ ì²˜ë¦¬
      mixedSource.onerror = function(event) {
          updateConnectionStatus(false, 'ì—°ê²° ì¢…ë£Œë¨');
          addLog('âŒ ì—°ê²° ì—ëŸ¬ ë˜ëŠ” ì¢…ë£Œ');

          if (mixedSource.readyState === EventSource.CLOSED) {
              addLog('ğŸ”Œ ëª¨ë“  ì´ë²¤íŠ¸ ì „ì†¡ ì™„ë£Œ - ì—°ê²° ì¢…ë£Œ');
          }
      };
  }

  function stopMixedEvents() {
      if (mixedSource) {
          mixedSource.close();
          updateConnectionStatus(false, 'ìˆ˜ë™ìœ¼ë¡œ ì¤‘ì§€ë¨');
          addLog('ğŸ›‘ ì‚¬ìš©ìê°€ ì—°ê²°ì„ ì¤‘ì§€í•¨');
          mixedSource = null;
      } else {
          addLog('âš ï¸ ì¤‘ì§€í•  ì—°ê²°ì´ ì—†ìŒ');
      }
  }

  // UI í—¬í¼ í•¨ìˆ˜ë“¤
  function showSection(sectionId) {
           document.getElementById(sectionId).style.display = 'block';
       }

       function resetUI() {
           // ëª¨ë“  ì´ë²¤íŠ¸ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
           const sections = ['welcome-section', 'notification-section', 'data-section',
                           'numbered-section', 'goodbye-section'];
           sections.forEach(id => {
               document.getElementById(id).style.display = 'none';
           });

           // ë‚´ìš© ì´ˆê¸°í™”
           document.getElementById('welcome-content').innerHTML = '';
           document.getElementById('notification-content').innerHTML = '';
           document.getElementById('data-content').innerHTML = '';
           document.getElementById('numbered-content').innerHTML = '';
           document.getElementById('goodbye-content').innerHTML = '';
       }

       function updateConnectionStatus(connected, message) {
           const statusDiv = document.getElementById('connection-status');
           statusDiv.className = connected ? 'status connected' : 'status disconnected';
           statusDiv.textContent = message;
       }

       function addLog(message) {
           const logDiv = document.getElementById('event-log');
           const time = new Date().toLocaleTimeString();
           const logEntry = document.createElement('div');
           logEntry.innerHTML = `[${time}] ${message}`;
           logDiv.appendChild(logEntry);

           // ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ
           logDiv.scrollTop = logDiv.scrollHeight;
       }

       // ë¸Œë¼ìš°ì € ì•Œë¦¼ ê¶Œí•œ ìš”ì²­
       function requestNotificationPermission() {
           if ('Notification' in window && Notification.permission === 'default') {
               Notification.requestPermission().then(permission => {
                   addLog('ğŸ”” ì•Œë¦¼ ê¶Œí•œ: ' + permission);
               });
           }
       }

       // í˜ì´ì§€ ë¡œë“œ ì‹œ ì•Œë¦¼ ê¶Œí•œ ìš”ì²­
       window.addEventListener('load', function() {
           requestNotificationPermission();
           addLog('ğŸ“„ í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ - SSE í…ŒìŠ¤íŠ¸ ì¤€ë¹„ë¨');
       });

       // í˜ì´ì§€ ì¢…ë£Œ ì‹œ ì—°ê²° ì •ë¦¬
       window.addEventListener('beforeunload', function() {
           if (mixedSource) {
               mixedSource.close();
           }
       });
</script>
</body>
</html>